name: Run Playwright Tests
on:
  # push:
  #   branches:
  #     - main
  # pull_request: null
  workflow_dispatch:
    inputs:
      testSuite:
        description: Choose which test file to run
        required: true
        default: all
        type: choice
        options:
          - all
          - login
          - catalog
          - checkout
      browser:
        description: Choose browser to run tests on
        required: true
        default: chromium
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - chrome
          - edge
          - all
env:
  TEST_USER_NAME: ${{ secrets.TEST_USER_NAME }}
  TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
  BASE_URL: ${{ secrets.BASE_URL }}
jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Determine browser selection
        id: browser-logic
        run: |
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "browser=chromium" >> $GITHUB_OUTPUT
            exit 0
          fi

          # workflow_dispatch â†’ use selected browser
          if [ "${{ github.event.inputs.browser }}" = "all" ]; then
            echo "browser=all" >> $GITHUB_OUTPUT
          else
            echo "browser=${{ github.event.inputs.browser }}" >> $GITHUB_OUTPUT
          fi
      - name: Install Playwright browsers
        run: >
          if [ "${{ steps.browser-logic.outputs.browser }}" = "all" ]; then
            echo "Installing ALL Playwright browsers..."
            npx playwright install --with-deps
          else
            echo "Installing browser: ${{ steps.browser-logic.outputs.browser }}"
            npx playwright install ${{ steps.browser-logic.outputs.browser }} --with-deps
          fi
      - name: Determine test suite
        id: suite-logic
        run: |
          # Default (push/pull)
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "suite=" >> $GITHUB_OUTPUT
            exit 0
          fi

          case "${{ github.event.inputs.testSuite }}" in
            "login")    echo "suite=tests/login.spec.ts" >> $GITHUB_OUTPUT ;;
            "catalog")  echo "suite=tests/catalog.spec.ts" >> $GITHUB_OUTPUT ;;
            "checkout") echo "suite=tests/checkout.spec.ts" >> $GITHUB_OUTPUT ;;
            "all")      echo "suite=" >> $GITHUB_OUTPUT ;; # run all tests
          esac
      - name: Run Playwright tests
        if: always()          
        run: |
            BROWSER="firefox"     # <--- Script starts here
            SUITE="tests/checkout.spec.ts"

            if [ "$BROWSER" = "all" ]; then
            echo "Running ALL browsers for selected suite"
            npx playwright test $SUITE \
             --project=chromium \
             --project=firefox \
             --project=webkit \
             --project=chrome \
             --project=edge
            else
            echo "Running suite '$SUITE' on browser '$BROWSER'"
            npx playwright test $SUITE --project=$BROWSER
            fi
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
