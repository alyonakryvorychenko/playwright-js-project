name: Parametrized workflow for test/browser

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      testSuite:
        description: "Choose which test file to run"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - login
          - catalog
          - checkout
      browser:
        description: "Choose browser to run tests on"
        required: true
        default: chromium
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - chrome
          - edge
          - all

env:
  TEST_USER_NAME: ${{ secrets.TEST_USER_NAME }}
  TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
  BASE_URL: ${{ secrets.BASE_URL }}

jobs:
  test:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci

      - name: Map browser input
        id: map
        run: |
          B="${{ github.event.inputs.browser }}"

          if [ "$B" = "" ]; then B="chromium"; fi

          case "$B" in
            chromium) INSTALL="chromium"; PROJECT="chromium" ;;
            firefox)  INSTALL="firefox";  PROJECT="firefox" ;;
            webkit)   INSTALL="webkit";   PROJECT="webkit" ;;
            chrome)   INSTALL="chrome";   PROJECT="chrome" ;;
            edge)     INSTALL="msedge";   PROJECT="edge" ;;  # config uses "edge"
            all)      INSTALL="all";      PROJECT="all" ;;
          esac

          echo "INSTALL=$INSTALL" >> $GITHUB_OUTPUT
          echo "PROJECT=$PROJECT" >> $GITHUB_OUTPUT

      - name: Install Playwright browsers
        run: |
          if [ "${{ steps.map.outputs.INSTALL }}" = "all" ]; then
            npx playwright install --with-deps
          else
            npx playwright install ${{ steps.map.outputs.INSTALL }} --with-deps
          fi

      - name: Run Playwright tests
        run: |
          # If not workflow_dispatch â†’ push/pull
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "Running ALL tests on chromium (push/pull)"
            npx playwright test --project=chromium
            exit 0
          fi

          # workflow_dispatch logic
          SUITE="${{ github.event.inputs.testSuite }}"

          # Resolve test file
          case "$SUITE" in
            login)    FILE="tests/login.spec.ts" ;;
            catalog)  FILE="tests/catalog.spec.ts" ;;
            checkout) FILE="tests/checkout.spec.ts" ;;
            all)      FILE="" ;; # run all
          esac

          PROJECT="${{ steps.map.outputs.PROJECT }}"

          if [ "$PROJECT" = "all" ]; then
            echo "Running ALL browsers"
            npx playwright test $FILE \
              --project=chromium \
              --project=firefox \
              --project=webkit \
              --project=chrome \
              --project=edge
          else
            echo "Running '$FILE' on '$PROJECT'"
            npx playwright test $FILE --project=$PROJECT
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
