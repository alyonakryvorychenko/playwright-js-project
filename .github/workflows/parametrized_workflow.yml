name: Parametrized workflow for test/browser

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      testSuite:
        description: "Choose which test file to run"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - login
          - catalog
          - checkout
      browser:
        description: "Choose browser to run tests on"
        required: true
        default: chromium
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - chrome
          - edge
          - all

env:
  TEST_USER_NAME: ${{ secrets.TEST_USER_NAME }}
  TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
  BASE_URL: ${{ secrets.BASE_URL }}

jobs:
  test:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci

      - name: Map browser input
        id: map
        run: |
          B="${{ github.event.inputs.browser }}"

          if [ "$B" = "" ]; then B="chromium"; fi

          case "$B" in
            chromium) INSTALL="chromium"; PROJECT="chromium" ;;
            firefox)  INSTALL="firefox";  PROJECT="firefox" ;;
            webkit)   INSTALL="webkit";   PROJECT="webkit" ;;
            chrome)   INSTALL="chrome";   PROJECT="chrome" ;;
            edge)     INSTALL="msedge";   PROJECT="edge" ;;  # config uses "edge"
            all)      INSTALL="all";      PROJECT="all" ;;
          esac

          echo "INSTALL=$INSTALL" >> $GITHUB_OUTPUT
          echo "PROJECT=$PROJECT" >> $GITHUB_OUTPUT

      - name: Install Playwright browsers
        run: |
          if [ "${{ steps.map.outputs.INSTALL }}" = "all" ]; then
            npx playwright install --with-deps
          else
            npx playwright install ${{ steps.map.outputs.INSTALL }} --with-deps
          fi

      - name: Run Playwright tests
        run: |
          # If not workflow_dispatch → push/pull
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "Running ALL tests on chromium (push/pull)"
            npx playwright test --project=chromium
            exit 0
          fi

          # workflow_dispatch logic
          SUITE="${{ github.event.inputs.testSuite }}"

          # Resolve test file
          case "$SUITE" in
            login)    FILE="tests/login.spec.ts" ;;
            catalog)  FILE="tests/catalog.spec.ts" ;;
            checkout) FILE="tests/checkout.spec.ts" ;;
            all)      FILE="" ;; # run all
          esac

          PROJECT="${{ steps.map.outputs.PROJECT }}"

          if [ "$PROJECT" = "all" ]; then
            echo "Running ALL browsers"
            npx playwright test $FILE \
              --project=chromium \
              --project=firefox \
              --project=webkit \
              --project=chrome \
              --project=edge
          else
            echo "Running '$FILE' on '$PROJECT'"
            npx playwright test $FILE --project=$PROJECT
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/

# on:
#   # push:
#   #   branches:
#   #     - main
#   # pull_request:
#   workflow_dispatch:
#     inputs:
#       testSuite:
#         description: "Choose which test file to run"
#         required: true
#         default: "all"
#         type: choice
#         options:
#           - all
#           - login
#           - catalog
#           - checkout
#       browser:
#         description: "Choose browser to run tests on"
#         required: true
#         default: chromium
#         type: choice
#         options:
#           - chromium
#           - chrome 
#           - firefox
#           - webkit
#           - all

# env:
#   TEST_USER_NAME: ${{ secrets.TEST_USER_NAME }}
#   TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
#   BASE_URL: ${{ secrets.BASE_URL }}

# jobs:
#   test:
#     name: Run Playwright Tests
#     runs-on: ubuntu-latest
#     environment: prod

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20

#       - name: Install dependencies
#         run: npm ci

#       # - name: Install Playwright browsers
#       #   run: npx playwright install --with-deps
#       # #         npx playwright install chromium/firefox/webkit -with-deps

#       # # - name: Run all Playwright tests
#       # #   run: npm test

#       # # - name: Run first set
#       # #   run: npm run test:login
#       # - name: Run Playwright tests on browser
#       #   run: |
#       #        if [ "${{ github.event.inputs.browser }}" = "all" ]; then
#       #          npx playwright test --project=chromium --project=firefox --project=webkit --project=chrome --project=msedge
#       #         else
#       #         npx playwright test --project=${{ github.event.inputs.browser }}
#       #        fi
#       # - name: Run selected tests
#       #   run: |
#       #     if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
#       #       case "${{ github.event.inputs.testSuite }}" in
#       #         "login") npm run test:login ;;
#       #         "catalog") npm run test:catalog ;;
#       #         "checkout") npm run test:checkout ;;
#       #         "all") npm test ;;
#       #       esac
#       #     else
#       #       # On push → always run all tests
#       #       npm test
#       #     fi
#       # - name: Upload test report
#       #   if: always()
#       #   uses: actions/upload-artifact@v4
#       #   with:
#       #     name: playwright-report
#       #     path: playwright-report/


#       - name: Determine browser to install
#         id: browser_selector
#         run: |
#           if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
#             echo "push/pull_request → browser = chromium"
#             echo "BROWSER=chromium" >> $GITHUB_OUTPUT
#           else
#             echo "workflow_dispatch → browser = ${{ github.event.inputs.browser }}"
#             echo "BROWSER=${{ github.event.inputs.browser }}" >> $GITHUB_OUTPUT
#           fi

#       - name: Install Playwright browser(s)
#         run: |
#           if [ "${{ steps.browser_selector.outputs.BROWSER }}" = "all" ]; then
#             echo "Installing ALL browsers..."
#             npx playwright install --with-deps
#           else
#             echo "Installing ONLY: ${{ steps.browser_selector.outputs.BROWSER }}"
#             npx playwright install ${{ steps.browser_selector.outputs.BROWSER }} --with-deps
#           fi

#       - name: Determine test suite
#         id: suite_selector
#         run: |
#           if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
#             echo "push/pull_request → test suite = all"
#             echo "SUITE=" >> $GITHUB_OUTPUT
#           else
#             case "${{ github.event.inputs.testSuite }}" in
#               login) echo "SUITE=tests/login.spec.ts" >> $GITHUB_OUTPUT ;;
#               catalog) echo "SUITE=tests/catalog.spec.ts" >> $GITHUB_OUTPUT ;;
#               checkout) echo "SUITE=tests/checkout.spec.ts" >> $GITHUB_OUTPUT ;;
#               all) echo "SUITE=" >> $GITHUB_OUTPUT ;; # empty = all tests
#             esac
#           fi

#       - name: Run Playwright tests
#         run: |
#           BROWSER="${{ steps.browser_selector.outputs.BROWSER }}"
#           SUITE="${{ steps.suite_selector.outputs.SUITE }}"

#           if [ "$BROWSER" = "all" ]; then
#             echo "Running all browsers"
#             npx playwright test $SUITE \
#               --project=chromium \
#               --project=firefox \
#               --project=webkit \
#               --project=chrome \
#           else
#             echo "Running suite '$SUITE' on browser '$BROWSER'"
#             npx playwright test $SUITE --project=$BROWSER
#           fi
#       - name: Upload test report
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: playwright-report
#           path: playwright-report/
